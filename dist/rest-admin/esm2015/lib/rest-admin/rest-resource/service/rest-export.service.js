import { Injectable } from "@angular/core";
import * as FileSaver from "file-saver";
import * as XLSX from "xlsx";
import jsPDF from "jspdf";
import "jspdf-autotable";
import * as JSZip from "jszip";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
const EXCEL_EXTENSION = ".xlsx";
const CSV_EXTENSION = ".csv";
const CSV_TYPE = "text/csv;charset=utf-8;";
const EXCEL_TYPE = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8;";
export const ALPHABET = [
    "A",
    "B",
    "C",
    "D",
    "E",
    "F",
    "G",
    "H",
    "I",
    "J",
    "K",
    "L",
    "M",
    "N",
    "O",
    "P",
    "Q",
    "R",
    "S",
    "T",
    "U",
    "V",
    "W",
    "X",
    "Y",
    "Z",
];
export class RestExportService {
    constructor(http) {
        this.http = http;
    }
    exportToExcel(data, fileName, param = false) {
        // inserting first blank row
        const worksheet = XLSX.utils.json_to_sheet(data[0].data, this.getOptions(data[0]));
        for (let i = 1, length = data.length; i < length; i++) {
            // adding a dummy row for separation
            XLSX.utils.sheet_add_json(worksheet, [{}], this.getOptions({
                data: [],
                skipHeader: true,
            }, -1));
            XLSX.utils.sheet_add_json(worksheet, data[i].data, this.getOptions(data[i], -1));
        }
        const workbook = {
            Sheets: { Sheet1: worksheet },
            SheetNames: ["Sheet1"],
        };
        const excelBuffer = XLSX.write(workbook, {
            bookType: "xlsx",
            type: "buffer",
        });
        const blob = new Blob([excelBuffer], {
            type: EXCEL_TYPE,
        });
        if (param) {
            return blob;
        }
        else {
            FileSaver.saveAs(blob, fileName + EXCEL_EXTENSION);
            return null;
        }
        // save to file
    }
    exportToCsv(header, data, fileName, param = false) {
        let csvData = this.ConvertToCSV(data, header);
        let blob = new Blob(["\ufeff" + csvData], {
            type: CSV_TYPE,
        });
        if (param)
            return blob;
        else {
            FileSaver.saveAs(blob, `${fileName}${CSV_EXTENSION}`);
        }
    }
    exportToPdf(header, data, fileName, fileTitle, param = false) {
        var doc = new jsPDF("l", "mm", [305, 250]);
        var col = header;
        var rows = [];
        var rowCountModNew = data;
        rowCountModNew.forEach((element) => {
            rows.push(element);
        });
        doc.autoTable(col, rows);
        doc.setProperties({
            title: fileName,
            subject: "List of " + fileName,
            author: "rest_admin",
            keywords: "generated, javascript, web 2.0, ajax",
            creator: "rest_admin",
        });
        if (param)
            return new Blob([doc.output("blob")], { type: "application/pdf" });
        else
            doc.save(`${fileName}.pdf`);
    }
    getOptions(json, origin) {
        // adding actual data
        const options = {
            skipHeader: true,
            origin: -1,
            header: [],
        };
        options.skipHeader = json.skipHeader ? json.skipHeader : false;
        if (!options.skipHeader && json.header && json.header.length) {
            options.header = json.header;
        }
        if (origin) {
            options.origin = origin ? origin : -1;
        }
        return options;
    }
    ConvertToCSV(objArray, headerList) {
        let array = typeof objArray != "object" ? JSON.parse(objArray) : objArray;
        let str = "";
        let row = "";
        for (let index in headerList) {
            row += headerList[index] + ",";
        }
        row = row.slice(0, -1);
        str += row + "\r\n";
        for (let i = 0; i < array.length; i++) {
            let line = "";
            headerList.forEach((element, index) => {
                let head = headerList[index];
                if (index == 0)
                    line += array[i][head];
                else
                    line += "," + array[i][head];
            });
            str += line + "\r\n";
        }
        return str;
    }
    generateZip(header, pdfData, csvData, excelData) {
        const conserved = true;
        const pdf = this.exportToPdf(header, pdfData, "rest_file_pdf", "", conserved);
        const csv = this.exportToCsv(header, csvData, "rest_file_csv", conserved);
        const excel = this.exportToExcel(excelData, "rest_file_excel", conserved);
        var zip = new JSZip();
        var document = zip.folder("rest_document");
        document.file("rest_file_pdf.pdf", pdf, { base64: true });
        document.file("rest_file_csv.csv", csv, { base64: true });
        document.file("rest_file_excel.xlsx", excel, { base64: true });
        zip.generateAsync({ type: "blob" }).then(function (content) {
            FileSaver.saveAs(content, "rest_document.zip");
        });
    }
    s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i != s.length; ++i)
            view[i] = s.charCodeAt(i) & 0xff;
        return buf;
    }
}
RestExportService.ɵfac = function RestExportService_Factory(t) { return new (t || RestExportService)(i0.ɵɵinject(i1.HttpClient)); };
RestExportService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: RestExportService, factory: RestExportService.ɵfac, providedIn: "root" });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(RestExportService, [{
        type: Injectable,
        args: [{
                providedIn: "root",
            }]
    }], function () { return [{ type: i1.HttpClient }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC1leHBvcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3Jlc3QtYWRtaW4vc3JjL2xpYi9yZXN0LWFkbWluL3Jlc3QtcmVzb3VyY2Uvc2VydmljZS9yZXN0LWV4cG9ydC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkQsT0FBTyxLQUFLLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDeEMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQzFCLE9BQU8saUJBQWlCLENBQUM7QUFDekIsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7OztBQUUvQixNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUM7QUFDaEMsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDO0FBQzdCLE1BQU0sUUFBUSxHQUFHLHlCQUF5QixDQUFDO0FBQzNDLE1BQU0sVUFBVSxHQUNkLGtGQUFrRixDQUFDO0FBQ3JGLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRztJQUN0QixHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztDQUNKLENBQUM7QUFLRixNQUFNLE9BQU8saUJBQWlCO0lBQzVCLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENB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Q0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsSUFBSSxJQUFJLEdBQUcsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDO1lBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ3JFLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQzs7a0ZBdktVLGlCQUFpQjt1RUFBakIsaUJBQWlCLFdBQWpCLGlCQUFpQixtQkFGaEIsTUFBTTt1RkFFUCxpQkFBaUI7Y0FIN0IsVUFBVTtlQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFBhcmFtcyB9IGZyb20gXCJAYW5ndWxhci9jb21tb24vaHR0cFwiO1xuaW1wb3J0IHsgRWxlbWVudFJlZiwgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgKiBhcyBGaWxlU2F2ZXIgZnJvbSBcImZpbGUtc2F2ZXJcIjtcbmltcG9ydCAqIGFzIFhMU1ggZnJvbSBcInhsc3hcIjtcbmltcG9ydCBqc1BERiBmcm9tIFwianNwZGZcIjtcbmltcG9ydCBcImpzcGRmLWF1dG90YWJsZVwiO1xuaW1wb3J0ICogYXMgSlNaaXAgZnJvbSBcImpzemlwXCI7XG5cbmNvbnN0IEVYQ0VMX0VYVEVOU0lPTiA9IFwiLnhsc3hcIjtcbmNvbnN0IENTVl9FWFRFTlNJT04gPSBcIi5jc3ZcIjtcbmNvbnN0IENTVl9UWVBFID0gXCJ0ZXh0L2NzdjtjaGFyc2V0PXV0Zi04O1wiO1xuY29uc3QgRVhDRUxfVFlQRSA9XG4gIFwiYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQ7Y2hhcnNldD1VVEYtODtcIjtcbmV4cG9ydCBjb25zdCBBTFBIQUJFVCA9IFtcbiAgXCJBXCIsXG4gIFwiQlwiLFxuICBcIkNcIixcbiAgXCJEXCIsXG4gIFwiRVwiLFxuICBcIkZcIixcbiAgXCJHXCIsXG4gIFwiSFwiLFxuICBcIklcIixcbiAgXCJKXCIsXG4gIFwiS1wiLFxuICBcIkxcIixcbiAgXCJNXCIsXG4gIFwiTlwiLFxuICBcIk9cIixcbiAgXCJQXCIsXG4gIFwiUVwiLFxuICBcIlJcIixcbiAgXCJTXCIsXG4gIFwiVFwiLFxuICBcIlVcIixcbiAgXCJWXCIsXG4gIFwiV1wiLFxuICBcIlhcIixcbiAgXCJZXCIsXG4gIFwiWlwiLFxuXTtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiBcInJvb3RcIixcbn0pXG5leHBvcnQgY2xhc3MgUmVzdEV4cG9ydFNlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHt9XG5cbiAgcHVibGljIGV4cG9ydFRvRXhjZWwoZGF0YTogYW55W10sIGZpbGVOYW1lOiBzdHJpbmcsIHBhcmFtID0gZmFsc2UpIHtcbiAgICAvLyBpbnNlcnRpbmcgZmlyc3QgYmxhbmsgcm93XG4gICAgY29uc3Qgd29ya3NoZWV0OiBYTFNYLldvcmtTaGVldCA9IFhMU1gudXRpbHMuanNvbl90b19zaGVldChcbiAgICAgIGRhdGFbMF0uZGF0YSxcbiAgICAgIHRoaXMuZ2V0T3B0aW9ucyhkYXRhWzBdKVxuICAgICk7XG5cbiAgICBmb3IgKGxldCBpID0gMSwgbGVuZ3RoID0gZGF0YS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgLy8gYWRkaW5nIGEgZHVtbXkgcm93IGZvciBzZXBhcmF0aW9uXG4gICAgICBYTFNYLnV0aWxzLnNoZWV0X2FkZF9qc29uKFxuICAgICAgICB3b3Jrc2hlZXQsXG4gICAgICAgIFt7fV0sXG4gICAgICAgIHRoaXMuZ2V0T3B0aW9ucyhcbiAgICAgICAgICB7XG4gICAgICAgICAgICBkYXRhOiBbXSxcbiAgICAgICAgICAgIHNraXBIZWFkZXI6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICAtMVxuICAgICAgICApXG4gICAgICApO1xuICAgICAgWExTWC51dGlscy5zaGVldF9hZGRfanNvbihcbiAgICAgICAgd29ya3NoZWV0LFxuICAgICAgICBkYXRhW2ldLmRhdGEsXG4gICAgICAgIHRoaXMuZ2V0T3B0aW9ucyhkYXRhW2ldLCAtMSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgd29ya2Jvb2s6IFhMU1guV29ya0Jvb2sgPSB7XG4gICAgICBTaGVldHM6IHsgU2hlZXQxOiB3b3Jrc2hlZXQgfSxcbiAgICAgIFNoZWV0TmFtZXM6IFtcIlNoZWV0MVwiXSxcbiAgICB9O1xuICAgIGNvbnN0IGV4Y2VsQnVmZmVyOiBhbnkgPSBYTFNYLndyaXRlKHdvcmtib29rLCB7XG4gICAgICBib29rVHlwZTogXCJ4bHN4XCIsXG4gICAgICB0eXBlOiBcImJ1ZmZlclwiLFxuICAgIH0pO1xuXG4gICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtleGNlbEJ1ZmZlcl0sIHtcbiAgICAgIHR5cGU6IEVYQ0VMX1RZUEUsXG4gICAgfSk7XG5cbiAgICBpZiAocGFyYW0pIHtcbiAgICAgIHJldHVybiBibG9iO1xuICAgIH0gZWxzZSB7XG4gICAgICBGaWxlU2F2ZXIuc2F2ZUFzKGJsb2IsIGZpbGVOYW1lICsgRVhDRUxfRVhURU5TSU9OKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICAvLyBzYXZlIHRvIGZpbGVcbiAgfVxuXG4gIHB1YmxpYyBleHBvcnRUb0NzdihcbiAgICBoZWFkZXI6IHN0cmluZ1tdLFxuICAgIGRhdGE6IGFueSxcbiAgICBmaWxlTmFtZTogc3RyaW5nLFxuICAgIHBhcmFtID0gZmFsc2VcbiAgKSB7XG4gICAgbGV0IGNzdkRhdGEgPSB0aGlzLkNvbnZlcnRUb0NTVihkYXRhLCBoZWFkZXIpO1xuXG4gICAgbGV0IGJsb2IgPSBuZXcgQmxvYihbXCJcXHVmZWZmXCIgKyBjc3ZEYXRhXSwge1xuICAgICAgdHlwZTogQ1NWX1RZUEUsXG4gICAgfSk7XG5cbiAgICBpZiAocGFyYW0pIHJldHVybiBibG9iO1xuICAgIGVsc2Uge1xuICAgICAgRmlsZVNhdmVyLnNhdmVBcyhibG9iLCBgJHtmaWxlTmFtZX0ke0NTVl9FWFRFTlNJT059YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGV4cG9ydFRvUGRmKFxuICAgIGhlYWRlcjogc3RyaW5nW10sXG4gICAgZGF0YTogYW55LFxuICAgIGZpbGVOYW1lOiBzdHJpbmcsXG4gICAgZmlsZVRpdGxlOiBzdHJpbmcsXG4gICAgcGFyYW0gPSBmYWxzZVxuICApIHtcbiAgICB2YXIgZG9jID0gbmV3IGpzUERGKFwibFwiLCBcIm1tXCIsIFszMDUsIDI1MF0pO1xuICAgIHZhciBjb2wgPSBoZWFkZXI7XG4gICAgdmFyIHJvd3MgPSBbXTtcblxuICAgIHZhciByb3dDb3VudE1vZE5ldyA9IGRhdGE7XG5cbiAgICByb3dDb3VudE1vZE5ldy5mb3JFYWNoKChlbGVtZW50KSA9PiB7XG4gICAgICByb3dzLnB1c2goZWxlbWVudCk7XG4gICAgfSk7XG5cbiAgICAoZG9jIGFzIGFueSkuYXV0b1RhYmxlKGNvbCwgcm93cyk7XG4gICAgZG9jLnNldFByb3BlcnRpZXMoe1xuICAgICAgdGl0bGU6IGZpbGVOYW1lLFxuICAgICAgc3ViamVjdDogXCJMaXN0IG9mIFwiICsgZmlsZU5hbWUsXG4gICAgICBhdXRob3I6IFwicmVzdF9hZG1pblwiLFxuICAgICAga2V5d29yZHM6IFwiZ2VuZXJhdGVkLCBqYXZhc2NyaXB0LCB3ZWIgMi4wLCBhamF4XCIsXG4gICAgICBjcmVhdG9yOiBcInJlc3RfYWRtaW5cIixcbiAgICB9KTtcblxuICAgIGlmIChwYXJhbSlcbiAgICAgIHJldHVybiBuZXcgQmxvYihbZG9jLm91dHB1dChcImJsb2JcIildLCB7IHR5cGU6IFwiYXBwbGljYXRpb24vcGRmXCIgfSk7XG4gICAgZWxzZSBkb2Muc2F2ZShgJHtmaWxlTmFtZX0ucGRmYCk7XG4gIH1cblxuICBwcml2YXRlIGdldE9wdGlvbnMoanNvbjogYW55LCBvcmlnaW4/OiBudW1iZXIpOiBhbnkge1xuICAgIC8vIGFkZGluZyBhY3R1YWwgZGF0YVxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBza2lwSGVhZGVyOiB0cnVlLFxuICAgICAgb3JpZ2luOiAtMSxcbiAgICAgIGhlYWRlcjogW10sXG4gICAgfTtcbiAgICBvcHRpb25zLnNraXBIZWFkZXIgPSBqc29uLnNraXBIZWFkZXIgPyBqc29uLnNraXBIZWFkZXIgOiBmYWxzZTtcbiAgICBpZiAoIW9wdGlvbnMuc2tpcEhlYWRlciAmJiBqc29uLmhlYWRlciAmJiBqc29uLmhlYWRlci5sZW5ndGgpIHtcbiAgICAgIG9wdGlvbnMuaGVhZGVyID0ganNvbi5oZWFkZXI7XG4gICAgfVxuICAgIGlmIChvcmlnaW4pIHtcbiAgICAgIG9wdGlvbnMub3JpZ2luID0gb3JpZ2luID8gb3JpZ2luIDogLTE7XG4gICAgfVxuICAgIHJldHVybiBvcHRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBDb252ZXJ0VG9DU1Yob2JqQXJyYXksIGhlYWRlckxpc3QpIHtcbiAgICBsZXQgYXJyYXkgPSB0eXBlb2Ygb2JqQXJyYXkgIT0gXCJvYmplY3RcIiA/IEpTT04ucGFyc2Uob2JqQXJyYXkpIDogb2JqQXJyYXk7XG4gICAgbGV0IHN0ciA9IFwiXCI7XG4gICAgbGV0IHJvdyA9IFwiXCI7XG4gICAgZm9yIChsZXQgaW5kZXggaW4gaGVhZGVyTGlzdCkge1xuICAgICAgcm93ICs9IGhlYWRlckxpc3RbaW5kZXhdICsgXCIsXCI7XG4gICAgfVxuICAgIHJvdyA9IHJvdy5zbGljZSgwLCAtMSk7XG4gICAgc3RyICs9IHJvdyArIFwiXFxyXFxuXCI7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGxpbmUgPSBcIlwiO1xuICAgICAgaGVhZGVyTGlzdC5mb3JFYWNoKChlbGVtZW50LCBpbmRleCkgPT4ge1xuICAgICAgICBsZXQgaGVhZCA9IGhlYWRlckxpc3RbaW5kZXhdO1xuICAgICAgICBpZiAoaW5kZXggPT0gMCkgbGluZSArPSBhcnJheVtpXVtoZWFkXTtcbiAgICAgICAgZWxzZSBsaW5lICs9IFwiLFwiICsgYXJyYXlbaV1baGVhZF07XG4gICAgICB9KTtcbiAgICAgIHN0ciArPSBsaW5lICsgXCJcXHJcXG5cIjtcbiAgICB9XG4gICAgcmV0dXJuIHN0cjtcbiAgfVxuXG4gIHB1YmxpYyBnZW5lcmF0ZVppcChoZWFkZXIsIHBkZkRhdGEsIGNzdkRhdGEsIGV4Y2VsRGF0YSkge1xuICAgIGNvbnN0IGNvbnNlcnZlZCA9IHRydWU7XG4gICAgY29uc3QgcGRmID0gdGhpcy5leHBvcnRUb1BkZihcbiAgICAgIGhlYWRlcixcbiAgICAgIHBkZkRhdGEsXG4gICAgICBcInJlc3RfZmlsZV9wZGZcIixcbiAgICAgIFwiXCIsXG4gICAgICBjb25zZXJ2ZWRcbiAgICApO1xuICAgIGNvbnN0IGNzdiA9IHRoaXMuZXhwb3J0VG9Dc3YoaGVhZGVyLCBjc3ZEYXRhLCBcInJlc3RfZmlsZV9jc3ZcIiwgY29uc2VydmVkKTtcbiAgICBjb25zdCBleGNlbCA9IHRoaXMuZXhwb3J0VG9FeGNlbChleGNlbERhdGEsIFwicmVzdF9maWxlX2V4Y2VsXCIsIGNvbnNlcnZlZCk7XG5cbiAgICB2YXIgemlwID0gbmV3IEpTWmlwKCk7XG4gICAgdmFyIGRvY3VtZW50ID0gemlwLmZvbGRlcihcInJlc3RfZG9jdW1lbnRcIik7XG4gICAgZG9jdW1lbnQuZmlsZShcInJlc3RfZmlsZV9wZGYucGRmXCIsIHBkZiwgeyBiYXNlNjQ6IHRydWUgfSk7XG4gICAgZG9jdW1lbnQuZmlsZShcInJlc3RfZmlsZV9jc3YuY3N2XCIsIGNzdiwgeyBiYXNlNjQ6IHRydWUgfSk7XG4gICAgZG9jdW1lbnQuZmlsZShcInJlc3RfZmlsZV9leGNlbC54bHN4XCIsIGV4Y2VsLCB7IGJhc2U2NDogdHJ1ZSB9KTtcblxuICAgIHppcC5nZW5lcmF0ZUFzeW5jKHsgdHlwZTogXCJibG9iXCIgfSkudGhlbihmdW5jdGlvbiAoY29udGVudCkge1xuICAgICAgRmlsZVNhdmVyLnNhdmVBcyhjb250ZW50LCBcInJlc3RfZG9jdW1lbnQuemlwXCIpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzMmFiKHMpIHtcbiAgICB2YXIgYnVmID0gbmV3IEFycmF5QnVmZmVyKHMubGVuZ3RoKTtcbiAgICB2YXIgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1Zik7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgIT0gcy5sZW5ndGg7ICsraSkgdmlld1tpXSA9IHMuY2hhckNvZGVBdChpKSAmIDB4ZmY7XG4gICAgcmV0dXJuIGJ1ZjtcbiAgfVxufVxuIl19