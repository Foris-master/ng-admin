import { Injectable } from "@angular/core";
import * as FileSaver from "file-saver";
import * as XLSX from "xlsx";
import jsPDF from "jspdf";
import "jspdf-autotable";
import * as JSZip from "jszip";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
const EXCEL_EXTENSION = ".xlsx";
const CSV_EXTENSION = ".csv";
const CSV_TYPE = "text/csv;charset=utf-8;";
const EXCEL_TYPE = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8;";
export const ALPHABET = [
    "A",
    "B",
    "C",
    "D",
    "E",
    "F",
    "G",
    "H",
    "I",
    "J",
    "K",
    "L",
    "M",
    "N",
    "O",
    "P",
    "Q",
    "R",
    "S",
    "T",
    "U",
    "V",
    "W",
    "X",
    "Y",
    "Z",
];
export class RestExportService {
    constructor(http) {
        this.http = http;
    }
    exportToExcel(data, fileName, param = false) {
        // inserting first blank row
        const worksheet = XLSX.utils.json_to_sheet(data[0].data, this.getOptions(data[0]));
        for (let i = 1, length = data.length; i < length; i++) {
            // adding a dummy row for separation
            XLSX.utils.sheet_add_json(worksheet, [{}], this.getOptions({
                data: [],
                skipHeader: true,
            }, -1));
            XLSX.utils.sheet_add_json(worksheet, data[i].data, this.getOptions(data[i], -1));
        }
        const workbook = {
            Sheets: { Sheet1: worksheet },
            SheetNames: ["Sheet1"],
        };
        const excelBuffer = XLSX.write(workbook, {
            bookType: "xlsx",
            type: "buffer",
        });
        const blob = new Blob([excelBuffer], {
            type: EXCEL_TYPE,
        });
        if (param) {
            return blob;
        }
        else {
            FileSaver.saveAs(blob, fileName + EXCEL_EXTENSION);
            return null;
        }
        // save to file
    }
    exportToCsv(header, data, fileName, param = false) {
        let csvData = this.ConvertToCSV(data, header);
        let blob = new Blob(["\ufeff" + csvData], {
            type: CSV_TYPE,
        });
        if (param)
            return blob;
        else {
            FileSaver.saveAs(blob, `${fileName}${CSV_EXTENSION}`);
        }
    }
    exportToPdf(header, data, fileName, fileTitle, param = false) {
        var doc = new jsPDF("l", "mm", [305, 250]);
        var col = header;
        var rows = [];
        var rowCountModNew = data;
        rowCountModNew.forEach((element) => {
            rows.push(element);
        });
        doc.autoTable(col, rows);
        doc.setProperties({
            title: fileName,
            subject: "List of " + fileName,
            author: "rest_admin",
            keywords: "generated, javascript, web 2.0, ajax",
            creator: "rest_admin",
        });
        if (param)
            return new Blob([doc.output("blob")], { type: "application/pdf" });
        else
            doc.save(`${fileName}.pdf`);
    }
    getOptions(json, origin) {
        // adding actual data
        const options = {
            skipHeader: true,
            origin: -1,
            header: [],
        };
        options.skipHeader = json.skipHeader ? json.skipHeader : false;
        if (!options.skipHeader && json.header && json.header.length) {
            options.header = json.header;
        }
        if (origin) {
            options.origin = origin ? origin : -1;
        }
        return options;
    }
    ConvertToCSV(objArray, headerList) {
        let array = typeof objArray != "object" ? JSON.parse(objArray) : objArray;
        let str = "";
        let row = "";
        for (let index in headerList) {
            row += headerList[index] + ",";
        }
        row = row.slice(0, -1);
        str += row + "\r\n";
        for (let i = 0; i < array.length; i++) {
            let line = "";
            headerList.forEach((element, index) => {
                let head = headerList[index];
                if (index == 0)
                    line += array[i][head];
                else
                    line += "," + array[i][head];
            });
            str += line + "\r\n";
        }
        return str;
    }
    generateZip(header, pdfData, csvData, excelData) {
        const conserved = true;
        const pdf = this.exportToPdf(header, pdfData, "rest_file_pdf", "", conserved);
        const csv = this.exportToCsv(header, csvData, "rest_file_csv", conserved);
        const excel = this.exportToExcel(excelData, "rest_file_excel", conserved);
        var zip = new JSZip();
        var document = zip.folder("rest_document");
        document.file("rest_file_pdf.pdf", pdf, { base64: true });
        document.file("rest_file_csv.csv", csv, { base64: true });
        document.file("rest_file_excel.xlsx", excel, { base64: true });
        zip.generateAsync({ type: "blob" }).then(function (content) {
            FileSaver.saveAs(content, "rest_document.zip");
        });
    }
    s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i != s.length; ++i)
            view[i] = s.charCodeAt(i) & 0xff;
        return buf;
    }
}
RestExportService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.1.5", ngImport: i0, type: RestExportService, deps: [{ token: i1.HttpClient }], target: i0.ɵɵFactoryTarget.Injectable });
RestExportService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.1.5", ngImport: i0, type: RestExportService, providedIn: "root" });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.1.5", ngImport: i0, type: RestExportService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root",
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC1leHBvcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3Jlc3QtYWRtaW4vc3JjL2xpYi9yZXN0LWFkbWluL3Jlc3QtcmVzb3VyY2Uvc2VydmljZS9yZXN0LWV4cG9ydC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkQsT0FBTyxLQUFLLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDeEMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQzFCLE9BQU8saUJBQWlCLENBQUM7QUFDekIsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7OztBQUUvQixNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUM7QUFDaEMsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDO0FBQzdCLE1BQU0sUUFBUSxHQUFHLHlCQUF5QixDQUFDO0FBQzNDLE1BQU0sVUFBVSxHQUNkLGtGQUFrRixDQUFDO0FBQ3JGLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRztJQUN0QixHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztDQUNKLENBQUM7QUFLRixNQUFNLE9BQU8saUJBQWlCO0lBQzVCLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENB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Q0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsSUFBSSxJQUFJLEdBQUcsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDO1lBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ3JFLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQzs7OEdBdktVLGlCQUFpQjtrSEFBakIsaUJBQWlCLGNBRmhCLE1BQU07MkZBRVAsaUJBQWlCO2tCQUg3QixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBQYXJhbXMgfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uL2h0dHBcIjtcbmltcG9ydCB7IEVsZW1lbnRSZWYsIEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0ICogYXMgRmlsZVNhdmVyIGZyb20gXCJmaWxlLXNhdmVyXCI7XG5pbXBvcnQgKiBhcyBYTFNYIGZyb20gXCJ4bHN4XCI7XG5pbXBvcnQganNQREYgZnJvbSBcImpzcGRmXCI7XG5pbXBvcnQgXCJqc3BkZi1hdXRvdGFibGVcIjtcbmltcG9ydCAqIGFzIEpTWmlwIGZyb20gXCJqc3ppcFwiO1xuXG5jb25zdCBFWENFTF9FWFRFTlNJT04gPSBcIi54bHN4XCI7XG5jb25zdCBDU1ZfRVhURU5TSU9OID0gXCIuY3N2XCI7XG5jb25zdCBDU1ZfVFlQRSA9IFwidGV4dC9jc3Y7Y2hhcnNldD11dGYtODtcIjtcbmNvbnN0IEVYQ0VMX1RZUEUgPVxuICBcImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0O2NoYXJzZXQ9VVRGLTg7XCI7XG5leHBvcnQgY29uc3QgQUxQSEFCRVQgPSBbXG4gIFwiQVwiLFxuICBcIkJcIixcbiAgXCJDXCIsXG4gIFwiRFwiLFxuICBcIkVcIixcbiAgXCJGXCIsXG4gIFwiR1wiLFxuICBcIkhcIixcbiAgXCJJXCIsXG4gIFwiSlwiLFxuICBcIktcIixcbiAgXCJMXCIsXG4gIFwiTVwiLFxuICBcIk5cIixcbiAgXCJPXCIsXG4gIFwiUFwiLFxuICBcIlFcIixcbiAgXCJSXCIsXG4gIFwiU1wiLFxuICBcIlRcIixcbiAgXCJVXCIsXG4gIFwiVlwiLFxuICBcIldcIixcbiAgXCJYXCIsXG4gIFwiWVwiLFxuICBcIlpcIixcbl07XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogXCJyb290XCIsXG59KVxuZXhwb3J0IGNsYXNzIFJlc3RFeHBvcnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7fVxuXG4gIHB1YmxpYyBleHBvcnRUb0V4Y2VsKGRhdGE6IGFueVtdLCBmaWxlTmFtZTogc3RyaW5nLCBwYXJhbSA9IGZhbHNlKSB7XG4gICAgLy8gaW5zZXJ0aW5nIGZpcnN0IGJsYW5rIHJvd1xuICAgIGNvbnN0IHdvcmtzaGVldDogWExTWC5Xb3JrU2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoXG4gICAgICBkYXRhWzBdLmRhdGEsXG4gICAgICB0aGlzLmdldE9wdGlvbnMoZGF0YVswXSlcbiAgICApO1xuXG4gICAgZm9yIChsZXQgaSA9IDEsIGxlbmd0aCA9IGRhdGEubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgIC8vIGFkZGluZyBhIGR1bW15IHJvdyBmb3Igc2VwYXJhdGlvblxuICAgICAgWExTWC51dGlscy5zaGVldF9hZGRfanNvbihcbiAgICAgICAgd29ya3NoZWV0LFxuICAgICAgICBbe31dLFxuICAgICAgICB0aGlzLmdldE9wdGlvbnMoXG4gICAgICAgICAge1xuICAgICAgICAgICAgZGF0YTogW10sXG4gICAgICAgICAgICBza2lwSGVhZGVyOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgLTFcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICAgIFhMU1gudXRpbHMuc2hlZXRfYWRkX2pzb24oXG4gICAgICAgIHdvcmtzaGVldCxcbiAgICAgICAgZGF0YVtpXS5kYXRhLFxuICAgICAgICB0aGlzLmdldE9wdGlvbnMoZGF0YVtpXSwgLTEpXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHdvcmtib29rOiBYTFNYLldvcmtCb29rID0ge1xuICAgICAgU2hlZXRzOiB7IFNoZWV0MTogd29ya3NoZWV0IH0sXG4gICAgICBTaGVldE5hbWVzOiBbXCJTaGVldDFcIl0sXG4gICAgfTtcbiAgICBjb25zdCBleGNlbEJ1ZmZlcjogYW55ID0gWExTWC53cml0ZSh3b3JrYm9vaywge1xuICAgICAgYm9va1R5cGU6IFwieGxzeFwiLFxuICAgICAgdHlwZTogXCJidWZmZXJcIixcbiAgICB9KTtcblxuICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbZXhjZWxCdWZmZXJdLCB7XG4gICAgICB0eXBlOiBFWENFTF9UWVBFLFxuICAgIH0pO1xuXG4gICAgaWYgKHBhcmFtKSB7XG4gICAgICByZXR1cm4gYmxvYjtcbiAgICB9IGVsc2Uge1xuICAgICAgRmlsZVNhdmVyLnNhdmVBcyhibG9iLCBmaWxlTmFtZSArIEVYQ0VMX0VYVEVOU0lPTik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgLy8gc2F2ZSB0byBmaWxlXG4gIH1cblxuICBwdWJsaWMgZXhwb3J0VG9Dc3YoXG4gICAgaGVhZGVyOiBzdHJpbmdbXSxcbiAgICBkYXRhOiBhbnksXG4gICAgZmlsZU5hbWU6IHN0cmluZyxcbiAgICBwYXJhbSA9IGZhbHNlXG4gICkge1xuICAgIGxldCBjc3ZEYXRhID0gdGhpcy5Db252ZXJ0VG9DU1YoZGF0YSwgaGVhZGVyKTtcblxuICAgIGxldCBibG9iID0gbmV3IEJsb2IoW1wiXFx1ZmVmZlwiICsgY3N2RGF0YV0sIHtcbiAgICAgIHR5cGU6IENTVl9UWVBFLFxuICAgIH0pO1xuXG4gICAgaWYgKHBhcmFtKSByZXR1cm4gYmxvYjtcbiAgICBlbHNlIHtcbiAgICAgIEZpbGVTYXZlci5zYXZlQXMoYmxvYiwgYCR7ZmlsZU5hbWV9JHtDU1ZfRVhURU5TSU9OfWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBleHBvcnRUb1BkZihcbiAgICBoZWFkZXI6IHN0cmluZ1tdLFxuICAgIGRhdGE6IGFueSxcbiAgICBmaWxlTmFtZTogc3RyaW5nLFxuICAgIGZpbGVUaXRsZTogc3RyaW5nLFxuICAgIHBhcmFtID0gZmFsc2VcbiAgKSB7XG4gICAgdmFyIGRvYyA9IG5ldyBqc1BERihcImxcIiwgXCJtbVwiLCBbMzA1LCAyNTBdKTtcbiAgICB2YXIgY29sID0gaGVhZGVyO1xuICAgIHZhciByb3dzID0gW107XG5cbiAgICB2YXIgcm93Q291bnRNb2ROZXcgPSBkYXRhO1xuXG4gICAgcm93Q291bnRNb2ROZXcuZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xuICAgICAgcm93cy5wdXNoKGVsZW1lbnQpO1xuICAgIH0pO1xuXG4gICAgKGRvYyBhcyBhbnkpLmF1dG9UYWJsZShjb2wsIHJvd3MpO1xuICAgIGRvYy5zZXRQcm9wZXJ0aWVzKHtcbiAgICAgIHRpdGxlOiBmaWxlTmFtZSxcbiAgICAgIHN1YmplY3Q6IFwiTGlzdCBvZiBcIiArIGZpbGVOYW1lLFxuICAgICAgYXV0aG9yOiBcInJlc3RfYWRtaW5cIixcbiAgICAgIGtleXdvcmRzOiBcImdlbmVyYXRlZCwgamF2YXNjcmlwdCwgd2ViIDIuMCwgYWpheFwiLFxuICAgICAgY3JlYXRvcjogXCJyZXN0X2FkbWluXCIsXG4gICAgfSk7XG5cbiAgICBpZiAocGFyYW0pXG4gICAgICByZXR1cm4gbmV3IEJsb2IoW2RvYy5vdXRwdXQoXCJibG9iXCIpXSwgeyB0eXBlOiBcImFwcGxpY2F0aW9uL3BkZlwiIH0pO1xuICAgIGVsc2UgZG9jLnNhdmUoYCR7ZmlsZU5hbWV9LnBkZmApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPcHRpb25zKGpzb246IGFueSwgb3JpZ2luPzogbnVtYmVyKTogYW55IHtcbiAgICAvLyBhZGRpbmcgYWN0dWFsIGRhdGFcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgc2tpcEhlYWRlcjogdHJ1ZSxcbiAgICAgIG9yaWdpbjogLTEsXG4gICAgICBoZWFkZXI6IFtdLFxuICAgIH07XG4gICAgb3B0aW9ucy5za2lwSGVhZGVyID0ganNvbi5za2lwSGVhZGVyID8ganNvbi5za2lwSGVhZGVyIDogZmFsc2U7XG4gICAgaWYgKCFvcHRpb25zLnNraXBIZWFkZXIgJiYganNvbi5oZWFkZXIgJiYganNvbi5oZWFkZXIubGVuZ3RoKSB7XG4gICAgICBvcHRpb25zLmhlYWRlciA9IGpzb24uaGVhZGVyO1xuICAgIH1cbiAgICBpZiAob3JpZ2luKSB7XG4gICAgICBvcHRpb25zLm9yaWdpbiA9IG9yaWdpbiA/IG9yaWdpbiA6IC0xO1xuICAgIH1cbiAgICByZXR1cm4gb3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgQ29udmVydFRvQ1NWKG9iakFycmF5LCBoZWFkZXJMaXN0KSB7XG4gICAgbGV0IGFycmF5ID0gdHlwZW9mIG9iakFycmF5ICE9IFwib2JqZWN0XCIgPyBKU09OLnBhcnNlKG9iakFycmF5KSA6IG9iakFycmF5O1xuICAgIGxldCBzdHIgPSBcIlwiO1xuICAgIGxldCByb3cgPSBcIlwiO1xuICAgIGZvciAobGV0IGluZGV4IGluIGhlYWRlckxpc3QpIHtcbiAgICAgIHJvdyArPSBoZWFkZXJMaXN0W2luZGV4XSArIFwiLFwiO1xuICAgIH1cbiAgICByb3cgPSByb3cuc2xpY2UoMCwgLTEpO1xuICAgIHN0ciArPSByb3cgKyBcIlxcclxcblwiO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBsaW5lID0gXCJcIjtcbiAgICAgIGhlYWRlckxpc3QuZm9yRWFjaCgoZWxlbWVudCwgaW5kZXgpID0+IHtcbiAgICAgICAgbGV0IGhlYWQgPSBoZWFkZXJMaXN0W2luZGV4XTtcbiAgICAgICAgaWYgKGluZGV4ID09IDApIGxpbmUgKz0gYXJyYXlbaV1baGVhZF07XG4gICAgICAgIGVsc2UgbGluZSArPSBcIixcIiArIGFycmF5W2ldW2hlYWRdO1xuICAgICAgfSk7XG4gICAgICBzdHIgKz0gbGluZSArIFwiXFxyXFxuXCI7XG4gICAgfVxuICAgIHJldHVybiBzdHI7XG4gIH1cblxuICBwdWJsaWMgZ2VuZXJhdGVaaXAoaGVhZGVyLCBwZGZEYXRhLCBjc3ZEYXRhLCBleGNlbERhdGEpIHtcbiAgICBjb25zdCBjb25zZXJ2ZWQgPSB0cnVlO1xuICAgIGNvbnN0IHBkZiA9IHRoaXMuZXhwb3J0VG9QZGYoXG4gICAgICBoZWFkZXIsXG4gICAgICBwZGZEYXRhLFxuICAgICAgXCJyZXN0X2ZpbGVfcGRmXCIsXG4gICAgICBcIlwiLFxuICAgICAgY29uc2VydmVkXG4gICAgKTtcbiAgICBjb25zdCBjc3YgPSB0aGlzLmV4cG9ydFRvQ3N2KGhlYWRlciwgY3N2RGF0YSwgXCJyZXN0X2ZpbGVfY3N2XCIsIGNvbnNlcnZlZCk7XG4gICAgY29uc3QgZXhjZWwgPSB0aGlzLmV4cG9ydFRvRXhjZWwoZXhjZWxEYXRhLCBcInJlc3RfZmlsZV9leGNlbFwiLCBjb25zZXJ2ZWQpO1xuXG4gICAgdmFyIHppcCA9IG5ldyBKU1ppcCgpO1xuICAgIHZhciBkb2N1bWVudCA9IHppcC5mb2xkZXIoXCJyZXN0X2RvY3VtZW50XCIpO1xuICAgIGRvY3VtZW50LmZpbGUoXCJyZXN0X2ZpbGVfcGRmLnBkZlwiLCBwZGYsIHsgYmFzZTY0OiB0cnVlIH0pO1xuICAgIGRvY3VtZW50LmZpbGUoXCJyZXN0X2ZpbGVfY3N2LmNzdlwiLCBjc3YsIHsgYmFzZTY0OiB0cnVlIH0pO1xuICAgIGRvY3VtZW50LmZpbGUoXCJyZXN0X2ZpbGVfZXhjZWwueGxzeFwiLCBleGNlbCwgeyBiYXNlNjQ6IHRydWUgfSk7XG5cbiAgICB6aXAuZ2VuZXJhdGVBc3luYyh7IHR5cGU6IFwiYmxvYlwiIH0pLnRoZW4oZnVuY3Rpb24gKGNvbnRlbnQpIHtcbiAgICAgIEZpbGVTYXZlci5zYXZlQXMoY29udGVudCwgXCJyZXN0X2RvY3VtZW50LnppcFwiKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgczJhYihzKSB7XG4gICAgdmFyIGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihzLmxlbmd0aCk7XG4gICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpICE9IHMubGVuZ3RoOyArK2kpIHZpZXdbaV0gPSBzLmNoYXJDb2RlQXQoaSkgJiAweGZmO1xuICAgIHJldHVybiBidWY7XG4gIH1cbn1cbiJdfQ==